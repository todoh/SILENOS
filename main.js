// ===================================
// ARCHIVO PRINCIPAL - INICIALIZACI√ìN Y GLOBALES
// ===================================

// --- VARIABLES GLOBALES ---
let guionLiterarioData = [];
let escenas = JSON.parse(localStorage.getItem("escenas")) || {};
let escenaActual = 'a';
let ultimoId = 0;
let titulo2 = document.getElementById("titulo-proyecto").innerText;

let indiceCapituloActivo = -1;
let draggedFrameIndex = null;
let draggedFrameEscenaId = null;
let currentDragOverFrameElement = null;

let chatDiv = document.getElementById("chat");

// --- Variables para la generaci√≥n autom√°tica desde el panel de IA ---
let nombredelahistoria = "Nombre de la Historia";
let cantidaddeescenas = 2;
let cantidadframes = 3;


// --- INICIALIZACI√ìN DE LA APLICACI√ìN ---
window.onload = function() {
    let escenasGuardadas = localStorage.getItem("escenas");
    if (escenasGuardadas) {
        escenas = JSON.parse(escenasGuardadas);
        // Calcular el √∫ltimo ID para evitar colisiones al crear nuevas escenas
        const ids = Object.keys(escenas).map(id => parseInt(id.match(/\d+/g) ? id.match(/\d+/g).pop() : 0));
        ultimoId = Math.max(0, ...ids);
        actualizarLista();
    }
    
    // Aplicar el tema guardado al cargar
    const themeToggleButton = document.getElementById('theme-toggle-button');
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        if (themeToggleButton) themeToggleButton.textContent = '‚òÄÔ∏è';
    } else {
        if (themeToggleButton) themeToggleButton.textContent = 'üåô';
    }
    // Cargar valores iniciales de los inputs de IA
    actualizarParametrosIA();
};

document.getElementById("titulo-proyecto").addEventListener("input", function() {
    titulo2 = document.getElementById("titulo-proyecto").innerText;
});

// --- FUNCIONES GENERALES DE UI ---
function cerrartodo() {
    document.getElementById('personajes').style.display = 'none';
    document.getElementById('lugares').style.display = 'none';
    document.getElementById('ia').style.display = 'none';
    document.getElementById('escena-vista').style.display = 'none';
    document.getElementById('escenah').style.display = 'none';
    document.getElementById('guion-literario').style.display = 'none';
}

function abrir(escena) {
    document.getElementById(escena).style.display = 'flex';
}

function gridear(escena) {
    document.getElementById(escena).style.display = 'grid';
}

function reiniciar() {
    if (confirm("¬øReiniciar el proyecto?, perder√°s todos los cambios sin guardar.")) {
        localStorage.removeItem("escenas"); // <-- CORRECCI√ìN A√ëADIDA AQU√ç
        window.location.reload(true);
    }
}

function guardarCambios() {
    localStorage.setItem("escenas", JSON.stringify(escenas));
}

function toggleTheme() {
    document.body.classList.toggle('dark-theme');
    const themeToggleButton = document.getElementById('theme-toggle-button');
    if (document.body.classList.contains('dark-theme')) {
        localStorage.setItem('theme', 'dark');
        if (themeToggleButton) themeToggleButton.textContent = '‚òÄÔ∏è';
    } else {
        localStorage.setItem('theme', 'light');
        if (themeToggleButton) themeToggleButton.textContent = 'üåô';
    }
}

function herramientacopiar() {
    const chatParagraphs = chatDiv.getElementsByTagName("p");
    if (chatParagraphs.length === 0) return;
    const lastMessage = chatParagraphs[chatParagraphs.length - 1].innerText;
    document.execCommand('copy');
}

// Actualiza las variables globales desde los inputs del panel de IA
function actualizarParametrosIA() {
    nombredelahistoria = document.getElementById("nombrehistoria").value;
    cantidaddeescenas = parseInt(document.getElementById("cantidadescenas").value) || 0;
    cantidadframes = parseInt(document.getElementById("cantidadeframes").value) || 0;
    
    // Para compatibilidad con geminialfa.js que usa window
    window.cantidaddeescenas = cantidaddeescenas;
    window.cantidadframes = cantidadframes;
}
