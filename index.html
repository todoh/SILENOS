<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Silenos Versión 1.1.8</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="styles2.css">
<link rel="stylesheet" href="clarooscuro.css">
<link rel="stylesheet" href="momentos.css">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>S</text></svg>">

<!-- ▼▼▼ SCRIPTS DE GOOGLE MODIFICADOS PARA DRIVE API ▼▼▼ -->
<script src="https://apis.google.com/js/api.js" async defer></script>
<script src="https://accounts.google.com/gsi/client" onload="gapiLoaded()" async defer></script>
<!-- ▲▲▲ FIN SCRIPTS DE GOOGLE ▲▲▲ -->

</head>
<body>
<style>
    /* Estilo para el contenedor del contador de llamadas a la API */
    #api-call-counter-container {
        position: fixed;
        bottom: 20px;
        left: 75px; 
        display: flex;
        align-items: center;
        background-color: var(--color-fondo-secundario, #f0f0f0);
        color: var(--color-texto, #333);
        border: 1px solid var(--color-borde, #ccc);
        padding: 5px 12px;
        border-radius: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        font-size: 14px;
        font-weight: 500;
        z-index: 9998;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        pointer-events: none;
    }
    #api-call-counter-container.visible {
        opacity: 1;
        transform: translateY(0);
    }
    #api-call-count {
        margin-left: 6px;
        font-weight: bold;
        background-color: var(--color-primario, #1877f2);
        color: white;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 12px;
    }
    .status-indicator {
        position: fixed;
        bottom: 20px;
        display: flex;
        align-items: center;
        background-color: var(--color-fondo-secundario, #f0f0f0);
        color: var(--color-texto, #333);
        border: 1px solid var(--color-borde, #ccc);
        padding: 5px 12px;
        border-radius: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        font-size: 14px;
        font-weight: 500;
        z-index: 9998;
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        pointer-events: none;
    }
    .status-indicator.visible {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }
    #api-call-counter-container {
        left: 75px;
    }
    #progress-bar-container {
        left: 215px;
        width: 250px;
    }
    #progress-bar-label {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px;
        margin-right: 8px;
    }
    .progress-bar-background {
        flex-grow: 1;
        height: 12px;
        background-color: var(--color-fondo, #e9ecef);
        border-radius: 6px;
        overflow: hidden;
    }
    #progress-bar-fill {
        width: 0%;
        height: 100%;
        background-color: #28a745;
        border-radius: 6px;
        transition: width 0.3s ease-in-out, background-color 0.3s ease;
    }
    #progress-bar-percentage {
        margin-left: 8px;
        font-weight: bold;
        font-size: 12px;
        min-width: 35px;
        text-align: right;
    }
    #google-auth-container {
        position: absolute;
        bottom: 20px;
        left: 20px;
        z-index: 10001;
    }
    #user-session-display {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 5px 10px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        color: #333;
    }
    #user-avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid white;
    }
    #user-name {
        font-weight: 500;
    }
    #drive-save-button, #logout-button {
        font-size: 18px;
        padding: 4px;
        background: transparent;
        border: none;
        cursor: pointer;
    }
    .dark-theme #user-session-display {
        background-color: rgba(30, 30, 30, 0.8);
        color: #eee;
    }

    /* ▼▼▼ ESTILOS MEJORADOS PARA EL BOTÓN DE GOOGLE ▼▼▼ */
    #google-signin-button {
        /* Se quitan las clases pro/pro3 para tener control total */
        background-color: #FFFFFF;
        color: #444;
        border: 1px solid #DADCE0;
        border-radius: 25px; /* Más redondeado */
        padding: 10px 24px;
        font-size: 16px;
        font-weight: 500;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        cursor: pointer;
        display: inline-flex; /* Para alinear el logo y el texto */
        align-items: center;
        justify-content: center;
        gap: 12px; /* Espacio entre el logo y el texto */
        transition: background-color .3s, box-shadow .3s;
        box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
    }

    #google-signin-button:hover {
        background-color: #F8F9FA;
        box-shadow: 0 1px 3px 0 rgba(60,64,67,0.3), 0 4px 8px 3px rgba(60,64,67,0.15);
    }

    #google-signin-button img {
        width: 18px;
        height: 18px;
    }
    /* ▲▲▲ FIN DE ESTILOS MEJORADOS ▲▲▲ */

</style>
<script>
  /**
     * Función de animación de entrada.
     * Orquesta una aparición en 3 fases: Esfera -> Botón S -> UI Principal.
     * Corrige la aparición brusca de la interfaz.
     */
    function flexear(id) {
        const silenosUI = document.getElementById(id);
        const principio = document.getElementById('principio');
        const esfera = document.getElementById('esfera');
        const menuPrincipio = document.getElementById('menuprincipio');
        const titulo1 = document.getElementById('titulo1');
        const asistenteBtn = document.getElementById('asistente-btn');

        // 1. Ocultar el contenido de la pantalla de inicio
        menuPrincipio.style.opacity = '0';
        titulo1.style.opacity = '0';

        // 2. Iniciar la expansión de la esfera
        esfera.classList.add('expandir');

        // 3. Programar la aparición del botón 'S'
        setTimeout(() => {
            asistenteBtn.classList.add('visible');
        }, 1000);

        // 4. Programar la aparición suave de la UI principal
        setTimeout(() => {
            // Hacemos visible el contenedor pero lo mantenemos transparente
            silenosUI.style.display = 'flex';
            
            // *** ✨ LA CORRECCIÓN CLAVE ✨ ***
            // Usamos requestAnimationFrame para asegurarnos de que el navegador
            // procesa el cambio de 'display' ANTES de aplicar el cambio de 'opacity'.
            // Esto permite que la transición de opacidad se ejecute correctamente.
            requestAnimationFrame(() => {
                silenosUI.style.opacity = '1';
            });

        }, 1500); // La UI comienza a aparecer a los 1.5 segundos

        // 5. Limpiar la pantalla de inicio cuando la animación termine
        setTimeout(() => {
            principio.style.display = 'none';
        }, 4000); // Debe coincidir con la duración de la animación de la esfera
    }

function animacionReiniciar() {
        const silenosUI = document.getElementById('silenos');
        const principio = document.getElementById('principio');
        const esfera = document.getElementById('esfera');
        const menuPrincipio = document.getElementById('menuprincipio');
        const titulo1 = document.getElementById('titulo1');
        const asistenteBtn = document.getElementById('asistente-btn');

        // 1. Aseguramos que el contenedor de la pantalla de inicio esté visible
        //    para que la esfera tenga un fondo sobre el que encogerse.
        if (principio) principio.style.display = 'flex';

        // 2. Inicia la desaparición de la UI principal y el botón 'S'.
        if (silenosUI) silenosUI.style.opacity = '0';
        if (asistenteBtn) asistenteBtn.classList.remove('visible');

        // 3. Después de un breve instante, inicia la animación de la esfera encogiéndose.
        //    Esto se logra simplemente quitando la clase 'expandir'.
        setTimeout(() => {
            if (esfera) esfera.classList.remove('expandir');
        }, 500); // 0.5s de retraso para que la UI empiece a desaparecer primero.

        // 4. A mitad de la animación de la esfera, empieza a reaparecer el texto y menú inicial.
        setTimeout(() => {
            if (menuPrincipio) menuPrincipio.style.opacity = '1';
            if (titulo1) titulo1.style.opacity = '1';
        }, 2000); // 2s de retraso.

        // 5. Al finalizar toda la animación, oculta completamente el contenedor de la UI principal
        //    con 'display: none' para que no interfiera con la página.
        setTimeout(() => {
            if (silenosUI) silenosUI.style.display = 'none';
        }, 4000); // Debe coincidir con la duración de la animación de la esfera (4s).
    }



</script>
<!-- El resto de tu body no cambia -->
<div id="principio" >
    <div id="titulo1">
        <div>
            <span>SILEN</span><span class="os-red">OS</span>
        </div>
        <div class="version-text">
            versión 1.1.8
        </div>
    </div>
    <div id="esfera" ></div>
    <div id="menuprincipio">
        <button class="pro3 pro" onclick="flexear('silenos');">Nuevo</button>
        <button class="pro3 pro" onclick="document.getElementById('file-load').click()">Cargar</button>
    </div>
 
</div>
   
<div id="silenos" >
    <div id="opciones" >
        <h2 id="titulo-proyecto" contenteditable="true" placeholder="Escribe el título del proyecto">Silenos Versión 1.1.8</h2>
        <div id="menu" >
            <button  onclick="cerrartodo(), gridear('personajes'),agregarBotonEliminarAPersonajes();">Datos</button>
            <button  onclick="cerrartodo(), abrir('momentos');">Momentos</button>
            <button  onclick="cerrartodo(), abrir('capitulosh');">Capitulos</button>
            <button  onclick="cerrartodo(), abrir('escenah');">Escenas</button>
            <button  onclick="cerrartodo(), abrirGuion();">Guion</button>
            <button  onclick="cerrartodo(), abrir('ia');">IA</button>
            <button class="pro" onclick="reiniciar()"> 🆕 </button>
            <button class="pro" onclick="abrirModalExportar()">💽 Export</button>
            <button class="pro" onclick="guardarJSON()">💾 Save</button>
            <input type="file" id="file-load" accept="application/json"  onchange="cargarJSON(event)" style="display: none;">
            <button class="pro" onclick="document.getElementById('file-load').click()">🗂️ Load</button>
            <button class="pro" onclick="abrirModalConfig()"> ⚙️ </button>
            <button class="pro" style="display: none;" id="import-data-button" onclick="abrirModalImportar()">📥</button>
            <button class="pro" id="theme-toggle-button" onclick="toggleTheme()">🌙</button>
        </div>
    </div>
 
 
<div id="momentos">
    <div id="momentos-controles-flotantes">
        <button class="pro" id="agregar-momento-btn">Añadir Momento</button>
                    <button class="pro" id="preview-connections-btn" title="Muestra u oculta las líneas de conexión entre momentos.">Previsualizar Conexiones</button>

        <div class="control-group">
            <button class="pro" id="zoom-out-btn" title="Alejar la vista">-</button>
            <span id="zoom-level-indicator">100%</span>
            <button class="pro" id="zoom-in-btn" title="Acercar la vista">+</button>
        </div>

        
        <div id="momentos-controles-ia">
            <button class="pro" id="generar-aventura-ia-btn" title="Usa la IA para generar una aventura interactiva completa a partir del guion seleccionado.">Generar Aventura con IA ✨</button>
            <select id="guion-select" class="pro" title="Selecciona un guion para usar como base para la IA"></select>

            <input type="number" id="ia-call-budget-input" class="pro ia-input-numero" min="5" max="100" value="15" title="Presupuesto de Llamadas a la IA. Define el número máximo de peticiones para crear y expandir ramas en la historia. Un número más alto crea una aventura más grande y compleja.">
            </div>
    </div>

    <div id="momentos-lienzo-wrapper">
        <div id="momentos-lienzo">
            <svg id="connections-svg"></svg>
        </div>
    </div>
</div>


<div id="guion-literario">
    <div id="guion-toolbar">
        <button class="pro" id="sumar-capitulo-guion" onclick="agregarCapituloYMostrar()">Agregar Capítulo</button>
        </div>
    <div id="guion-layout">
        <div id="indice-capitulos-guion">
            </div>
        <div id="contenido-capitulo-activo">
            </div>
    </div>
</div>

<div id="ia" >
    <div id="creasion" >
        <button class="pro" onclick="cerrartodo(), abrir('capitulosh'), actualizarParametrosIA(), crearEscenasAutomaticamente(nombredelahistoria, cantidaddeescenas, cantidadframes);">Insertar Capítulos vacíos en la Historia</button>
        <input type="text" id="nombrehistoria" placeholder="Nombre de las Escenas" value="Nombre de la Historia">
        <input type="number" id="cantidadescenas" placeholder= "Cantidad de Escenas" value="2">
        <input type="number" id="cantidadeframes" placeholder= "Cantidad de Frames" value="3">
    </div>

    <textarea id="gemini1"  placeholder="Escribe tu Historia..."></textarea>

    <div id="chateo" >
        <div id="ia-options">
            <input type="checkbox" id="incluir-datos-ia" checked>
            <label for="incluir-datos-ia">Usar Datos ya Guardados en la generación de la Historia</label>
        </div>
        <div id="ia-buttons">
            <button id="enviargemini"  class="pro" onclick="actualizarParametrosIA(), enviarTextoConInstrucciones()">Generar Historia</button>
            <button id="enviargemini-desarrollar"  class="pro" onclick="actualizarParametrosIA(), desarrollarFramesDesdeGeminimente(nombredelahistoria); cerrartodo(); abrir('capitulosh');">Insertar Frames en la Historia</button>
        </div>
    </div>

    <div id="geminimente"></div>
</div>


<div id="editor">
      <p></p>
      <p></p>
      <p></p>
<div id="chat"></div>
<button onclick="herramientacopiar()"> 📥 </button><div id="herramienta" ></div>
<textarea id="user-input" placeholder="Escribe tu mensaje..."></textarea>
<button id="enviar" onclick="enviartexto()">Enviar</button>
<div id="modos" ></div></div>

<div id="escenah">
    <div class="escena-toolbar">
        <button id="crear-escena-btn">Nueva Escena</button>
        <select id="escenas-dropdown"></select>
        <input type="text" id="escena-nombre-input" placeholder="Nombre de la Escena...">
        <button id="agregar-toma-btn">Añadir Toma (8s)</button>
    </div>
    <div id="tomas-timeline">
        </div>
</div>


<div id="capitulosh"  >
<button class="pro" id="sumarpersonaje" onclick="nuevaEscena()">Agregar Capítulo</button>
<div id="capitulos" >
<div id="lista-capitulos"></div></div></div>

<div id="personajes">
    <div id="datos-botones-superiores">
        <button class="pro" id="sumarpersonaje" onclick="agregarPersonaje()">Agregar Dato</button>
        <button class="pro" id="sumarpersonaje-ia" onclick="abrirModalAIDatos()">Añadir Datos con IA ✨</button>
    </div>
    <div id="listapersonajes"></div>
</div>

<div id="escena-vista">
    <textarea id="escena-texto" placeholder="Texto de la escena"></textarea>
    <div id="drop-zone"   >
        <img id="imagen-preview" alt="Vista previa de la imagen">
    <input type="file" id="file-input" accept="image/*, video/mp4, video/webm, image/gif"  style="display: none;" ></div>
<div id="botonesss"   >
    <button class="botoness" onclick="agregarBoton('transicion')">+ Botón de Transición</button>
    <button class="botoness" onclick="agregarBoton('accion')">+ Botón de Acción</button></div>
<div class="lista" > <div id="botones-lista"></div></div>
</div>
<video id="hiddenVideoPlayer" style="display:none;"></video>
<canvas id="hiddenCanvas" style="display:none;"></canvas>

<div id="modal-overlay"></div>

<div id="lugares" class="modal-content">
    <button class="modal-close-button" onclick="cerrarModalConfig()">&times;</button>
    <p>Para utilizar la inteligencia artificial de Silenos necesita:</p>
    <p>Una API KEY de GOOGLE, puede obtenerla aquí:</p>
    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer"  style="padding: 10px 20px; background-color: rgb(0, 0, 0); color: white; text-decoration: none; border-radius: 5px;">
     AI Studio de Google.com
    </a><p></p>
    <input type="text" id="apiInput" placeholder="Ingresa tu API Key">
    <button onclick="updateApiKey()">Actualizar</button>
    <p>API Key actual: <span id="apiKeyDisplay">[No definida]</span></p>
</div>

<div id="modal-importar-json" class="modal-content">
    <button class="modal-close-button" onclick="cerrarModalImportar()">&times;</button>
    <h3>Importar Datos desde JSON</h3>
    <p>Pega el contenido de un único objeto JSON (un dato, capítulo, etc.) en el siguiente campo.</p>
    <textarea id="json-import-area" placeholder='Ejemplo para un "Dato":\n{\n  "nombre": "Espada Legendaria",\n  "descripcion": "Forjada por los dioses.",\n  "etiqueta": "objeto",\n  "imagen": ""\n}'></textarea>
    <button class="modal-button" onclick="importarDatosDesdeJSON()">Añadir Datos</button>
</div>

<div id="modal-ia-datos" class="modal-content">
    <button class="modal-close-button" onclick="cerrarModalAIDatos()">&times;</button>
    <h3>Añadir Datos con Inteligencia Artificial</h3>
    <p>Pega aquí el nombre de una obra (ej: "Star Wars"), una lista de ideas, o un JSON para que la IA los procese y añada como datos estructurados.</p>
    <textarea id="ia-datos-area" placeholder='Ejemplo 1: El Señor de los Anillos

Ejemplo 2: Un caballero valiente llamado Arthur, su espada mágica Excalibur, el reino de Camelot.

Ejemplo 3: [{"nombre": "Dato 1", "descripcion": "..."}]'></textarea>
    <button class="modal-button" onclick="procesarEntradaConIA()">✨ Analizar y Agregar Datos</button>
</div>


<div id="modal-editar-momento" class="modal-content">
    <button class="modal-close-button" onclick="cerrarModalEditarMomento()">&times;</button>
    <h3>Editar Momento</h3>
    <input type="text" id="momento-editor-titulo" placeholder="Título del Momento">
    <textarea id="momento-editor-descripcion" placeholder="Descripción..."></textarea>
    <div id="momento-editor-drop-zone" class="drop-zone-estilo">
        Arrastra una imagen aquí o haz clic para seleccionarla
        <img id="momento-editor-imagen-preview" alt="Vista previa">
        <input type="file" id="momento-editor-file-input" accept="image/*" style="display: none;">
    </div>

    <div id="acciones-container"></div>

    <div class="modal-buttons-container">
        <button id="boton-agregar-accion" class="modal-button">Añadir Acción</button>
        <button class="modal-button" onclick="guardarCambiosMomento()">Guardar Cambios</button>
    </div>
</div>

<div id="modal-exportar" class="modal-content">
    <button class="modal-close-button" onclick="cerrarModalExportar()">&times;</button>
    <h3>Opciones de Exportación</h3>

    <div class="export-option">
        <h4>Exportar Guion</h4>
        <p>Exporta los capítulos y sus frames a un archivo HTML simple.</p>
        <button class="modal-button" onclick="generarHTML()">Exportar Guion HTML</button>
    </div>
   <div class="export-option">
        <h4>Exportar Storyboard de Tomas</h4>
        <p>Exporta las escenas de storyboard (imágenes y texto) a un archivo HTML.</p>

         <div class="export-controls">
             <select id="tomas-export-select" class="modal-select"></select>
             <button class="modal-button" onclick="generarHTMLTomas()">Exportar Tomas HTML</button>
        </div>    </div>
    <div class="export-option">
        <h4>Exportar Videojuego</h4>
        <p>Exporta los momentos como una experiencia interactiva.</p>
        <select id="momento-inicial-id" class="modal-select"></select>
        <button class="modal-button" onclick="iniciarExportacionJuego()">Exportar Videojuego HTML</button>
    </div>
</div>
 
 
 
 
 <button id="asistente-btn" title="Asistente IA"  style="display: none;" >S</button>

 
 
 
    <!-- ... Resto de tus divs de contenido ... -->
</div>


<div id="google-auth-container">
        <!-- El contenido se inserta aquí por google.js -->
    </div>



<!-- Scripts al final del body -->
<script src="gestionEscenas.js"></script>
<script src="momentos.js"></script>
<script src="guion.js"></script>
<script src="escenas.js"></script>
<script src="datos.js"></script>
<script src="io.js"></script>
<script src="gemini.js"></script>
<script src="geminialfa.js"></script>
<script src="geminivisual.js"></script>
<script src="exportar.js"></script>
<script src="exportarjuego.js"></script>
<script src="exportartomas.js"></script>
<script src="google.js"></script>
<script src="main.js"></script>

<!-- Resto de tu HTML al final... -->
</body>
</html>
