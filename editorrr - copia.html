<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor con Contenedores</title>
    <!-- Inclusión de Tailwind CSS para un diseño rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclusión de la fuente Inter de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos personalizados para complementar Tailwind */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        /* Estilo para el placeholder en los divs editables */
        [contenteditable][placeholder]:empty:before {
            content: attr(placeholder);
            color: #a0aec0;
            pointer-events: none;
            display: block;
        }
        
        /* Estilo visual para el módulo que se está arrastrando */
        .e-dragging {
            opacity: 0.4;
            border: 2px dashed #4a5568;
        }
        
        /* Zona donde se puede soltar un módulo (antes de este) */
        .e-drag-over-zone { border-top: 3px solid #3b82f6 !important; }
        .e-drag-over-zone-bottom { border-bottom: 3px solid #3b82f6 !important; }

        .e-sidebar { height: 100vh; }
        .e-tool { cursor: grab; }
        .e-tool:active { cursor: grabbing; }
        
        /* Estilo para las zonas de soltar (drop zones) */
        .e-drop-container.e-drop-zone-active {
            outline: 2px dashed #3b82f6;
            outline-offset: -10px;
            background-color: #eff6ff;
        }
        /* Estilo específico para la zona de soltar anidada */
        .e-div-content-area.e-drop-zone-active {
            background-color: #dbeafe; /* Un azul más claro para anidados */
        }

        /* --- NUEVOS ESTILOS PARA PLEGADO --- */
        .e-div-module.e-collapsed .e-div-content-area {
            display: none;
        }

        .e-div-module.e-collapsed h3 {
            margin-bottom: 0; /* Quita el margen inferior del título cuando está plegado */
        }

        .e-div-module.e-collapsed .e-collapse-btn svg {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex">
        <!-- BARRA LATERAL FIJA CON HERRAMIENTAS ARRASTRABLES -->
        <aside class="e-sidebar w-64 bg-white p-6 shadow-lg sticky top-0">
            <h2 class="text-2xl font-bold text-gray-900 mb-8">Herramientas</h2>
            <div class="space-y-4">
                <!-- Herramienta de Texto -->
                <div draggable="true" data-tool="text" class="e-tool flex items-center gap-3 p-3 border rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M14 9.5a3.5 3.5 0 0 0-7 0v11"/><path d="M12 4.5H4"/><path d="M8 4.5H4"/></svg>
                    <span class="font-semibold">Texto</span>
                </div>
                <!-- Herramienta de Imagen -->
                <div draggable="true" data-tool="image" class="e-tool flex items-center gap-3 p-3 border rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    <span class="font-semibold">Imagen</span>
                </div>
                <!-- Herramienta de Contenedor (Div) -->
                <div draggable="true" data-tool="div" class="e-tool flex items-center gap-3 p-3 border rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-500"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="3" x2="9" y2="21"></line></svg>
                    <span class="font-semibold">Contenedor</span>
                </div>
            </div>
        </aside>

        <!-- ÁREA DE CONTENIDO PRINCIPAL -->
        <div class="flex-1">
            <div class="container mx-auto max-w-4xl p-4 sm:p-8">
                <header class="bg-white p-6 rounded-xl shadow-md mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Arrastra una herramienta aquí</h1>
                </header>
                <main id="e-editor-container" class="e-drop-container space-y-6 min-h-[50vh] rounded-xl transition-colors duration-300">
                    <!-- Los módulos se añadirán aquí dinámicamente -->
                </main>
            </div>
        </div>
        
        <input type="file" id="e-image-upload-input" class="hidden" accept="image/*">
    </div>

    <!-- Modal de Confirmación de Eliminación -->
    <div id="e-delete-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all duration-300 scale-95">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Confirmar Eliminación</h3>
            <p class="text-gray-600 mb-6">¿Estás seguro de que quieres eliminar este módulo? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-4">
                <button id="e-cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button id="e-confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Eliminar</button>
            </div>
        </div>
    </div>


    <script>
    // --- ESTADO GLOBAL ---
    let draggedItem = null;
    let activeImagePlaceholder = null;
    let moduleToDelete = null;

    // --- REFERENCIAS A ELEMENTOS DEL DOM ---
    const imageUploadInput = document.getElementById('e-image-upload-input');
    const deleteModal = document.getElementById('e-delete-confirm-modal');
    const confirmDeleteBtn = document.getElementById('e-confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('e-cancel-delete-btn');

    // --- CREACIÓN DE MÓDULOS ---

    function createModule(type, container, afterElement) {
        switch (type) {
            case 'text':
                const textContent = `<div contenteditable="true" placeholder="Escribe algo aquí..." class="prose max-w-none w-full focus:outline-none min-h-[80px]"></div>`;
                return buildModuleShell(textContent, container, afterElement);
            case 'image':
                const placeholderId = `e-placeholder-${Date.now()}`;
                const imageContent = `
                    <div id="${placeholderId}" class="w-full h-48 bg-gray-100 rounded-lg flex flex-col items-center justify-center text-gray-500 border-2 border-dashed cursor-pointer hover:bg-gray-200 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                        <span>Haz clic para subir una imagen</span>
                    </div>`;
                const imageModule = buildModuleShell(imageContent, container, afterElement);
                imageModule.querySelector(`#${placeholderId}`).addEventListener('click', () => {
                    activeImagePlaceholder = imageModule.querySelector(`#${placeholderId}`);
                    imageUploadInput.click();
                });
                return imageModule;
            case 'div':
                return createDivContainer(container, afterElement);
        }
    }
    
    function buildModuleShell(contentHTML, container, afterElement) {
        const moduleWrapper = document.createElement('div');
        moduleWrapper.className = 'e-module group bg-white p-4 rounded-xl shadow-sm hover:shadow-md relative transition-shadow duration-300';
        moduleWrapper.setAttribute('draggable', true);
        moduleWrapper.innerHTML = `
            <div class="absolute top-3 right-3 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <div class="e-drag-handle cursor-move bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded-full shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>
                <button class="e-delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" y2="17"/><line x1="14" y1="11" y2="17"/></svg></button>
            </div>
            ${contentHTML}`;
        
        container.insertBefore(moduleWrapper, afterElement);
        return moduleWrapper;
    }

    function createDivContainer(container, afterElement) {
        const divModule = document.createElement('div');
        divModule.className = 'e-module group e-div-module bg-white p-4 rounded-xl shadow-sm hover:shadow-md relative border-l-4 border-purple-400';
        divModule.setAttribute('draggable', true);
        divModule.innerHTML = `
            <div class="absolute top-3 right-3 flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                <button class="e-collapse-btn bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded-full shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300">
                        <path d="m6 9 6 6 6-6"/>
                    </svg>
                </button>
                <div class="e-drag-handle cursor-move bg-gray-200 hover:bg-gray-300 text-gray-600 p-2 rounded-full shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>
                <button class="e-delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-md"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" y2="17"/><line x1="14" y1="11" y2="17"/></svg></button>
            </div>
            <h3 contenteditable="true" placeholder="Nombre del Contenedor..." class="text-xl font-bold mb-4 focus:outline-none text-purple-800"></h3>
            <div class="e-div-content-area e-drop-container space-y-4 p-4 border-t min-h-[100px] bg-gray-50 rounded-lg">
                <!-- Nested modules go here -->
            </div>`;
        
        container.insertBefore(divModule, afterElement);
        return divModule;
    }

    // --- LÓGICA DE DRAG & DROP (DELEGACIÓN DE EVENTOS) ---

    let dragHandleIsDown = false; 

    document.addEventListener('mousedown', (e) => {
        if (e.target.closest('.e-drag-handle')) {
            dragHandleIsDown = true;
        }
    });

    document.addEventListener('mouseup', () => {
        dragHandleIsDown = false;
    });

    document.addEventListener('dragstart', (e) => {
        const tool = e.target.closest('.e-tool');
        if (tool) {
            draggedItem = { type: 'tool', tool: tool.dataset.tool };
            return;
        }

        const module = e.target.closest('.e-module');
        if (module) {
            if (dragHandleIsDown) {
                draggedItem = { type: 'module', element: module };
                setTimeout(() => module.classList.add('e-dragging'), 0);
            } else {
                e.preventDefault(); 
            }
        }
    });

    document.addEventListener('dragend', () => {
        if (draggedItem && draggedItem.type === 'module') {
            draggedItem.element.classList.remove('e-dragging');
        }
        draggedItem = null;
        dragHandleIsDown = false; 
        document.querySelectorAll('.e-drag-over-zone, .e-drag-over-zone-bottom, .e-drop-zone-active').forEach(el => {
            el.classList.remove('e-drag-over-zone', 'e-drag-over-zone-bottom', 'e-drop-zone-active');
        });
    });

    document.addEventListener('dragover', (e) => {
        e.preventDefault(); // Permitir soltar en cualquier parte del documento
        
        const dropContainer = e.target.closest('.e-drop-container');
        
        // Limpiar indicadores visuales anteriores
        document.querySelectorAll('.e-drag-over-zone, .e-drag-over-zone-bottom').forEach(el => {
            el.classList.remove('e-drag-over-zone', 'e-drag-over-zone-bottom');
        });

        if (dropContainer && draggedItem) {
            // Si estamos sobre un contenedor válido, mostrar el indicador de posición
            const afterElement = getDragAfterElement(dropContainer, e.clientY);
            if (afterElement) {
                afterElement.classList.add('e-drag-over-zone');
            } else {
                const lastElement = dropContainer.querySelector('.e-module:last-child:not(.e-dragging)');
                if (lastElement) {
                    lastElement.classList.add('e-drag-over-zone-bottom');
                }
            }
        }
    });

    document.addEventListener('dragenter', (e) => {
        const dropContainer = e.target.closest('.e-drop-container');
        if (dropContainer && draggedItem) {
            e.preventDefault();
            dropContainer.classList.add('e-drop-zone-active');
        }
    });

    document.addEventListener('dragleave', (e) => {
        const dropContainer = e.target.closest('.e-drop-container');
        if (dropContainer) {
            dropContainer.classList.remove('e-drop-zone-active');
        }
    });

    document.addEventListener('drop', (e) => {
        e.preventDefault();
        if (!draggedItem) return;

        let dropContainer = e.target.closest('.e-drop-container');
        let afterElement;

        if (dropContainer) {
            // Caso 1: Se suelta dentro de un contenedor válido
            afterElement = getDragAfterElement(dropContainer, e.clientY);
        } else {
            // Caso 2: Se suelta fuera de cualquier contenedor válido
            dropContainer = document.getElementById('e-editor-container');
            afterElement = null; // Esto hará que se añada al final
        }

        if (draggedItem.type === 'tool') {
            createModule(draggedItem.tool, dropContainer, afterElement);
        } else if (draggedItem.type === 'module') {
            dropContainer.insertBefore(draggedItem.element, afterElement);
        }
    });
    
    // --- LÓGICA DE ELIMINACIÓN, PLEGADO Y SUBIDA DE IMAGEN ---
    
    document.addEventListener('click', (e) => {
        const deleteBtn = e.target.closest('.e-delete-btn');
        if (deleteBtn) {
            const module = deleteBtn.closest('.e-module');
            if (module) {
                moduleToDelete = module;
                deleteModal.classList.remove('hidden');
                setTimeout(() => deleteModal.querySelector('div').classList.add('scale-100'), 10);
            }
            return;
        }

        const collapseBtn = e.target.closest('.e-collapse-btn');
        if (collapseBtn) {
            const module = collapseBtn.closest('.e-div-module');
            if (module) {
                module.classList.toggle('e-collapsed');
            }
        }
    });

    function hideModal() {
        const modalContent = deleteModal.querySelector('div');
        modalContent.classList.remove('scale-100');
        setTimeout(() => {
            deleteModal.classList.add('hidden');
            moduleToDelete = null;
        }, 300);
    }

    cancelDeleteBtn.addEventListener('click', hideModal);

    confirmDeleteBtn.addEventListener('click', () => {
        if (moduleToDelete) {
            moduleToDelete.style.transform = 'scale(0.95)';
            moduleToDelete.style.opacity = '0';
            setTimeout(() => moduleToDelete.remove(), 250);
        }
        hideModal();
    });

    imageUploadInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && activeImagePlaceholder) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = "max-w-full h-auto rounded-lg max-h-[350px]";
                img.alt = "Contenido subido por el usuario";
                activeImagePlaceholder.replaceWith(img);
                activeImagePlaceholder = null;
            };
            reader.readAsDataURL(file);
        }
        event.target.value = '';
    });

    // --- FUNCIÓN AUXILIAR ---
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll(':scope > .e-module:not(.e-dragging)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    </script>
</body>
</html>
